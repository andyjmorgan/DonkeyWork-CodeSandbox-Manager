version: '3.8'

services:
  kata-container-manager:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kata-container-manager
    ports:
      - "8668:8668"
    environment:
      - ASPNETCORE_URLS=http://+:8668
      - ASPNETCORE_ENVIRONMENT=Development
      # Kubernetes Configuration
      - KataContainerManager__TargetNamespace=sandbox-containers
      - KataContainerManager__RuntimeClassName=kata-qemu
      - KataContainerManager__DefaultImage=ghcr.io/andyjmorgan/donkeywork-codesandbox-executor:latest
      - KataContainerManager__DefaultResourceRequests__MemoryMi=128
      - KataContainerManager__DefaultResourceRequests__CpuMillicores=250
      - KataContainerManager__DefaultResourceLimits__MemoryMi=512
      - KataContainerManager__DefaultResourceLimits__CpuMillicores=1000
      - KataContainerManager__PodNamePrefix=kata-sandbox
      - KataContainerManager__CleanupCompletedPods=true
      - KataContainerManager__PodReadyTimeoutSeconds=90
      # MCP Server Configuration
      - KataContainerManager__McpServerImage=ghcr.io/andyjmorgan/donkeywork-codesandbox-mcpserver:latest
      - KataContainerManager__McpPodNamePrefix=kata-mcp
      - KataContainerManager__McpWarmPoolSize=5
      - KataContainerManager__McpIdleTimeoutMinutes=60
      - KataContainerManager__McpMaxContainerLifetimeMinutes=480
      # Serilog Configuration
      - Serilog__MinimumLevel__Default=Information
      - Serilog__MinimumLevel__Override__Microsoft=Warning
      - Serilog__MinimumLevel__Override__System=Warning
    volumes:
      # Mount kubeconfig for local development
      # Uncomment the following line if running locally outside Kubernetes
      # - ~/.kube/config:/root/.kube/config:ro
      - /tmp/kata-manager-logs:/tmp/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8668/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - kata-network

  code-execution-server:
    build:
      context: .
      dockerfile: src/DonkeyWork.CodeSandbox.Server/Dockerfile
    container_name: code-execution-server
    ports:
      - "8666:8666"
    environment:
      - ASPNETCORE_URLS=http://+:8666
      - ASPNETCORE_ENVIRONMENT=Development
      # Serilog Configuration
      - Serilog__MinimumLevel__Default=Information
      - Serilog__MinimumLevel__Override__Microsoft=Warning
      - Serilog__MinimumLevel__Override__System=Warning
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8666/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - kata-network

  auth-proxy:
    build:
      context: .
      dockerfile: src/DonkeyWork.CodeSandbox.AuthProxy/Dockerfile
    container_name: auth-proxy
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ProxyConfiguration__ProxyPort=8080
      - ProxyConfiguration__HealthPort=8081
      - ProxyConfiguration__AllowedDomains__0=httpbin.org
      - ProxyConfiguration__AllowedDomains__1=graph.microsoft.com
      - ProxyConfiguration__AllowedDomains__2=api.github.com
      - ProxyConfiguration__AllowedDomains__3=github.com
      - ProxyConfiguration__CaCertificatePath=/certs/ca.crt
      - ProxyConfiguration__CaPrivateKeyPath=/certs/ca.key
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - kata-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sandbox-frontend
    ports:
      - "3000:80"
    environment:
      - API_BACKEND_URL=http://kata-container-manager:8668
    depends_on:
      - kata-container-manager
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - kata-network

networks:
  kata-network:
    driver: bridge
